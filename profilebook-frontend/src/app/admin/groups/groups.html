<div class="groups-container container mt-4">

  <!-- Toolbar -->
  <div class="toolbar d-flex justify-content-between align-items-center mb-4 p-3 rounded shadow-sm bg-gradient">
    <h3 class="m-0 fw-bold text-white">Admin • Groups</h3>
    <div class="toolbar-actions d-flex flex-wrap gap-2">
      <a class="btn btn-primary" href="/admin/posts">Approve Posts</a>
      <a class="btn btn-danger" href="/admin/reports">Reports</a>
      <a class="btn btn-info text-white" href="/admin/users">Users</a>
      <a class="btn btn-secondary" href="/posts">Back to Posts</a>
      <button class="btn btn-warning fw-semibold text-dark" (click)="fetch()" [disabled]="loading">
        <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
        {{ loading ? 'Refreshing…' : 'Refresh' }}
      </button>
    </div>
  </div>

  <!-- Create Group -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex gap-2 flex-wrap align-items-center">
      <input [(ngModel)]="newGroupName"
             class="form-control rounded-pill"
             placeholder="New group name (e.g., Developers, Design, QA…)" />
      <button class="btn btn-success rounded-pill px-4"
              (click)="createGroup()"
              [disabled]="creating || !newGroupName?.trim()">
        <span *ngIf="creating" class="spinner-border spinner-border-sm me-1"></span>
        {{ creating ? 'Creating…' : 'Create Group' }}
      </button>
    </div>
  </div>

  <!-- Groups -->
  <div class="card shadow-sm border-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-primary">
          <tr>
            <th>ID</th>
            <th>Group Name</th>
            <th>Members</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let g of groups">
            <td class="text-muted">{{ g.id }}</td>
            <td class="fw-semibold">{{ g.groupName }}</td>

            <!-- Members -->
            <td>
              <div *ngIf="g.members?.length; else noMembers" class="d-flex flex-wrap gap-2">
                <span class="badge rounded-pill bg-secondary d-flex align-items-center px-3 py-2" *ngFor="let m of g.members">
                  {{ m.username }}
                  <button type="button"
                          class="btn-close btn-close-white ms-2"
                          [disabled]="removingBusy[g.id + ':' + m.userId]"
                          (click)="removeMember(g.id, m.userId)">
                  </button>
                </span>
              </div>
              <ng-template #noMembers>
                <span class="text-muted">No members</span>
              </ng-template>
            </td>

            <!-- Actions -->
            <td class="text-center">
              <div *ngIf="addingForGroupId !== g.id; else addRow" class="d-flex flex-column gap-2 align-items-center">
                <button class="btn btn-outline-primary btn-sm rounded-pill" (click)="startAddMember(g.id)">
                  Add Member
                </button>

                <div class="input-group input-group-sm">
                  <input type="number" class="form-control" placeholder="User ID" [(ngModel)]="addUserId" min="1" />
                  <button class="btn btn-success" (click)="confirmAddMember(g.id)" [disabled]="addingBusy">
                    <span *ngIf="addingBusy" class="spinner-border spinner-border-sm"></span>
                    Add
                  </button>
                </div>
                <div class="form-text">Tip: you can search users with Add Member button</div>
              </div>

              <!-- Add row with search -->
              <ng-template #addRow>
                <div class="p-2 border rounded bg-light">
                  <input type="text"
                         class="form-control form-control-sm mb-2"
                         placeholder="Search user by username or email"
                         [(ngModel)]="memberSearch"
                         (input)="onMemberSearch()" />

                  <ul *ngIf="memberResults?.length" class="list-group mb-2">
                    <li *ngFor="let u of memberResults" class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <strong>{{ u.username }}</strong>
                        <div class="text-muted small">{{ u.email }}</div>
                      </div>
                      <button class="btn btn-success btn-sm" (click)="confirmAddMember(g.id, u.id)">Add</button>
                    </li>
                  </ul>

                  <div *ngIf="memberSearch && !memberResults?.length && !searching" class="text-muted small">
                    No users found.
                  </div>
                  <div *ngIf="searching" class="text-muted small">Searching…</div>

                  <button class="btn btn-outline-danger btn-sm w-100" (click)="cancelAddMember()">Cancel</button>
                </div>
              </ng-template>
            </td>
          </tr>

          <tr *ngIf="!loading && !groups.length">
            <td colspan="4" class="text-center text-muted py-4">No groups yet. Create your first group above!</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
